{{extend 'layout.html'}}


{{block head}}
<script src="{{=URL('static', 'js/vue.js')}}"></script>
<script>
    var api_url = "{{=URL('api', 'get_coordinates')}}";
    var categories_url = "{{=URL('api', 'get_categories')}}";
</script>

{{end}}
        <!-- if logged in -->
{{if auth.user_id:}}

    <div class="make_report text-left">
    <a href="{{=URL('default', 'submit')}}" class="btn btn-warning">
    <i class="fa fa-plus"></i> New Report
    </a>
    </div>

    <div class="view_report text-left"  >
    <a href="{{=URL('default', 'view')}}" class="btn btn-success">
                View Reports
    </a>
    </div>

{{pass}}

<div id="vue-div">
    <div class="report_list" v-if="!is_making_report">
    <ul>
        {{for r in reports:}}
       <li>{{=r.cat_id.cat_title}} by {{=r.user_id.first_name}} {{=r.user_id.last_name}}</li>
        {{pass}}
    </ul>
    </div>

    <div class="create_report" v-if="is_making_report">
        <form action="#" v-on:submit.prevent="add_report" class="form-horizontal" enctype="multipart/form-data" method="post">
                <div class="form-group" id="no_table_content__row">
                    <div>
                        <textarea class="form-control string" id="new-report" v-model="form_report_content" placeholder="Type message" type="text" rows="5"> </textarea>
                        <span class="help-block"></span>
                    </div>
                </div>

                <div class="form-group" id="reports_cat_id__row">
                    <label class="control-label col-sm-3" for="reports_cat_id" id="reports_cat_id__label">Categories</label>
                    <div class="col-sm-9">
                        <select class="generic-widget form-control" id="reports_cat_id" name="cat_id" >
                            <option v-for="c in categories">${c.cat_title}</option>
                        </select>
                        <span class="help-block"></span>
                    </div>
                </div>

                <div class="form-group" id="post-button">
                    <div>
                        <!-- disable the button post, if 1) the content is null, 2) if the content only contains whitespace
                        For condition 2 code taken from https://goo.gl/dv8NrQ -->
                        <button class="post-button" id="post-button" type="submit" v-on:click="add_report_div()" v-bind:disabled="form_report_content===null ||  !(/\S/.test(form_report_content))" >Post </button>
                    </div>
                </div>

            </form>
    </div>
</div>




<!DOCTYPE html>
<html>
  <head>
    <style>
      #map {
        width:70%;
        height:550px;
        float:right;
       }

      html,body{
        width:100%;

      }
    </style>
  </head>
  <body>
    <div id="map">
    </div>
    <script>

        // used in deleting prvious marker if user clicks again
        var prev_marker;
      function initMap() {

          // make map obj global by not doing: var map = ...
          map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
              // center is set for now as the first element in banana table
                center: {lat:36.996164, lng:-122.05864}
          });

          // used for reverse geocoding (to get the municipality from location given by the user)
          var geocoder = new google.maps.Geocoder;
          var infowindow = new google.maps.InfoWindow;

          // add a marker on every click.
          google.maps.event.addListener(map, 'click', function(event) {

              // location of click
              var click_location = new google.maps.LatLng(event.latLng.lat(), event.latLng.lng());

              // if not null (user clicks for second/third/... time) delete the previous marker
              // and add a new one via function placeMarker
              if(prev_marker != null){
                prev_marker.setMap(null);
            }

            var clicked_marker = placeMarker(click_location);

              // we're creating a report
              if(APP.vue.is_making_report === false)
                APP.vue.add_report_div();

              reverse_geocoding(geocoder,map,infowindow,click_location,clicked_marker);
          });

        }

            // function to place the marker on the map
            function placeMarker(location) {
                var marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
                // make the current marker the prev marker
                prev_marker = marker;

                return marker;
            }

            function reverse_geocoding(geocoder,map,infowindow,location,marker){


                geocoder.geocode({'location': location}, function(results, status) {
                  if (status === 'OK') {
                    if (results[0]) {

                        // go through the address_components and for each address_component list go through
                        // the types in it. If a type is administrative_area_level_2, then this is the name of the
                        // county.
                        for(var i = 0; i < results[0].address_components.length; i++){
                            for(var j = 0; j < results[0].address_components[i].types.length; j++){
                                if (results[0].address_components[i].types[j] === "administrative_area_level_2"){
                                    APP.vue.municipality = results[0].address_components[i].long_name;
                                    break;
                                }
                            }
                        }
                      infowindow.setContent(results[0].formatted_address);
                      infowindow.open(map, marker);
                    } else {
                      window.alert('No results found');
                    }
                  } else {
                    window.alert('Geocoder failed due to: ' + status);
                  }
                });
            }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATlgK06ECpUjfJC5zF9IIkaK1czediuxM&callback=initMap">
    </script>
    <script src="{{=URL('static', 'js/default_index.js')}}"></script>
  </body>
</html>



